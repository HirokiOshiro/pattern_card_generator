<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パターンカード生成ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ヒラギノ角ゴ ProN', 'Hiragino Kaku Gothic ProN', '游ゴシック', YuGothic, 'メイリオ', Meiryo, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 25%, #CDDC39 50%, #FFC107 75%, #ff0c9ea6 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .header .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            justify-content: center;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* フォント選択特有のスタイル */
        #fontSelect {
            font-weight: 500;
            background: #fafbfc;
        }
        
        #fontSelect option {
            padding: 8px;
        }
        
        .templates {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .template-btn {
            aspect-ratio: 3/2;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .template-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .template-btn.active {
            border: 3px solid #667eea;
            background: #f8f9ff;
            color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
            font-weight: 600;
        }
        
        .template-btn.active::before {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        .template-academic { background: linear-gradient(135deg, #ffffff, #d0d0d0); }
        .template-nature { background: linear-gradient(135deg, #259e56, #f4f269); }
        .template-warm { background: linear-gradient(135deg, #fff95b, #ff930f); }
        .template-elegant { background: linear-gradient(135deg, #d4af37, #c0c0c0); }
        .template-pastel { background: linear-gradient(135deg, #e9e9b7, #d3f3f1); }
        .template-spring { background: linear-gradient(135deg, #fce9d7, #eed4e8); }
        .template-summer { background: linear-gradient(135deg, #f6f6f6, #2c6cbc); }
        .template-autumn { background: linear-gradient(135deg, #fdd57e, #924e8c); }
        .template-winter { background: linear-gradient(135deg, #f1f5f9, #475569); }
        .template-custom { background: linear-gradient(135deg, #f5f5f5, #e8e8e8); }
        
        /* カラーカスタマイズ用スタイル */
        .color-customization {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
        }
        
        .color-inputs {
            display: grid;
            gap: 10px;
        }
        
        .color-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .color-input-group label {
            font-size: 12px;
            color: #555;
            margin: 0;
        }
        
        .color-input-group input[type="color"] {
            width: 50px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }
        
        .palette-management {
            border-top: 1px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .saved-palette {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 8px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .palette-colors {
            display: flex;
            gap: 3px;
        }
        
        .palette-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        
        .palette-actions {
            display: flex;
            gap: 3px;
        }
        
        .palette-action-btn {
            padding: 2px 6px;
            font-size: 10px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .palette-action-btn:hover {
            background: #f0f0f0;
        }
        
        /* カラーカスタマイズ専用スタイル */
        .custom-color-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .custom-color-toggle:hover {
            background: #f0f4f8;
            border-color: #d1d9e0;
        }
        
        .custom-color-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }
        
        .custom-color-toggle.active {
            background: #e8f4f8;
            border-color: #667eea;
            color: #2c5aa0;
        }
        .template-custom { background: #ffffff; border: 2px solid #e1e8ed; }
        
        .main-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .preview-header h2 {
            font-size: 1.4em;
            color: #444;
        }
        
        .canvas-container {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            overflow: hidden;
            background: #fafbfc;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            max-width: 100%;
            height: 660px; /* 888×600px + パディング */
            margin: 0 auto;
        }
        
        #cardCanvas {
            border: 1px solid #ddd;
            display: block;
            margin: 0 auto;
            max-width: 888px;
            max-height: 600px;
            width: 888px !important;
            height: 600px !important;
        }
        
        .batch-section {
            border-top: 2px solid #f1f3f4;
            padding-top: 30px;
        }
        
        .batch-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            background: #fafbfc;
        }
        
        .pattern-item {
            padding: 4px 6px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            word-wrap: break-word;
            overflow: hidden;
            position: relative;
        }
        
        .pattern-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.12);
        }
        
        .pattern-item.selected {
            background: #f8f9ff;
            color: #667eea;
            border: 2px solid #667eea;
            font-weight: 600;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2);
        }
        
        .pattern-item.selected::before {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 10px;
            font-weight: bold;
            color: #667eea;
            background: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.3);
            z-index: 1;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }
        
        .info-panel {
            background: #f8f9ff;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .info-panel p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        /* CSV編集関連スタイル */
        .csv-row-editing {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }
        
        .csv-edit-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }
        
        .csv-edit-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* AI活用ガイド関連スタイル */
        .ai-guide-section {
            margin-bottom: 30px;
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fcff, #e8f4fd);
            overflow: hidden;
        }

        .ai-guide-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ai-guide-header:hover {
            background: linear-gradient(135deg, #5a6fd8, #6842a0);
        }

        .ai-guide-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .ai-guide-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .ai-guide-toggle.expanded {
            transform: rotate(180deg);
        }

        .ai-guide-content {
            padding: 20px;
            display: none;
        }

        .ai-guide-content.expanded {
            display: block;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .template-card h4 {
            color: #667eea;
            margin: 0 0 10px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            background: #f9fafb;
        }

        .copy-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #5a6fd8;
        }

        .copy-button.copied {
            background: #10b981;
        }

        .step-guide {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .step-guide h4 {
            color: #0369a1;
            margin: 0 0 10px 0;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* ファイル名カスタマイズ関連スタイル */
        .file-name-controls {
            border: 1px solid #e0e7ff;
            border-radius: 6px;
            padding: 8px 12px;
            background: #f8fcff;
        }

        .file-name-controls input {
            transition: border-color 0.3s ease;
        }

        .file-name-controls input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .csv-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .file-name-controls {
                margin-left: 0 !important;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>パターン・カード生成ツール</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="resetAll()">
                    🔄 リセット
                </button>
                <button class="btn btn-primary" onclick="exportCurrentCard()">
                    📂 現在のカードを保存
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- サイドバー -->
            <div class="sidebar">
                <div class="info-panel">
                    <h3>📚 井庭崇先生のパターン・ランゲージを活用したクリエティブ・ラーニングの考えから着想を得たツール</h3>
                    <p>井庭先生の創造的学習のための40のパターンカードから選択したカードを出力したり、オリジナルのパターンカードを作成して出力することができます。</p>
                </div>

                <div class="form-group">
                    <label for="patternSelect">パターン選択</label>
                    <select id="patternSelect" onchange="loadPatternData()">
                        <option value="">カスタム（独自作成）</option>
                        <option value="0">0. 学習をデザインする</option>
                        <option value="1">1. 機会をつくる</option>
                        <option value="2">2. 創造的なプロジェクト</option>
                        <option value="3">3. オープンプロセスな学び</option>
                        <option value="4">4. まずはつかる</option>
                        <option value="5">5. 見まね学習</option>
                        <option value="6">6. 効果的な質問</option>
                        <option value="7">7. アウトプット志向の学習</option>
                        <option value="8">8. 毎日外国語</option>
                        <option value="9">9. 遊び心のある学習</option>
                        <option value="10">10. 身体化されたスキル</option>
                        <option value="11">11. 言葉のシャワー</option>
                        <option value="12">12. 有形の蓄積</option>
                        <option value="13">13. 学習の竜巻</option>
                        <option value="14">14. 三角スケーリング</option>
                        <option value="15">15. 興奮の連鎖！</option>
                        <option value="16">16. 行動の中での思考</option>
                        <option value="17">17. プロトタイピング</option>
                        <option value="18">18. フィールドダイビング</option>
                        <option value="19">19. マルチカメラ撮影</option>
                        <option value="20">20. 鳥の目・虫の目</option>
                        <option value="21">21. 隠れたつながり</option>
                        <option value="22">22. フロンティア発見者</option>
                        <option value="23">23. 創造的スイッチ</option>
                        <option value="24">24. 果物農業</option>
                        <option value="25">25. 初稿は道半ば</option>
                        <option value="26">26. 魅力的表現</option>
                        <option value="27">27. 次への加速</option>
                        <option value="28">28. 学習のコミュニティ</option>
                        <option value="29">29. 偶然の出会い</option>
                        <option value="30">30. 良きライバル</option>
                        <option value="31">31. 話す思考者</option>
                        <option value="32">32. 教えることによる学習</option>
                        <option value="33">33. 確固たる決意</option>
                        <option value="34">34. 疑問を持つ心</option>
                        <option value="35">35. 正しい方法</option>
                        <option value="36">36. 勇敢な変化</option>
                        <option value="37">37. 探検家の情熱</option>
                        <option value="38">38. 自己プロデューサー</option>
                        <option value="39">39. 極端になれ！</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>デザインテンプレート</label>
                    <div class="templates">
                        <!-- 基本テーマ -->
                        <div class="template-btn template-academic active" data-template="academic" onclick="selectTemplate('academic')">
                            アカデミック
                        </div>
                        <div class="template-btn template-nature" data-template="nature" onclick="selectTemplate('nature')">
                            ナチュラル
                        </div>
                        <div class="template-btn template-warm" data-template="warm" onclick="selectTemplate('warm')">
                            ウォーム
                        </div>
                        <div class="template-btn template-elegant" data-template="elegant" onclick="selectTemplate('elegant')">
                            エレガント
                        </div>
                        
                        <!-- 新テーマ -->
                        <div class="template-btn template-pastel" data-template="pastel" onclick="selectTemplate('pastel')">
                            パステル
                        </div>
                        
                        <!-- 季節テーマ -->
                        <div class="template-btn template-spring" data-template="spring" onclick="selectTemplate('spring')">
                            🌸 春
                        </div>
                        <div class="template-btn template-summer" data-template="summer" onclick="selectTemplate('summer')">
                            🌻 夏
                        </div>
                        <div class="template-btn template-autumn" data-template="autumn" onclick="selectTemplate('autumn')">
                            🍂 秋
                        </div>
                        <div class="template-btn template-winter" data-template="winter" onclick="selectTemplate('winter')">
                            ❄️ 冬
                        </div>
                        
                        <!-- カスタム -->
                        <div class="template-btn template-custom" data-template="custom" onclick="selectTemplate('custom')">
                            🛠️ カスタム
                        </div>
                    </div>
                </div>

                <div class="form-group" id="customBackgroundGroup" style="display: none;">
                    <label for="backgroundUpload">背景画像をアップロード</label>
                    <input type="file" id="backgroundUpload" accept="image/*" onchange="handleBackgroundUpload(event)">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        推奨サイズ: 888×600px または同じ比率の画像
                    </small>
                </div>

                <div class="form-group">
                    <label for="fontSelect">フォント選択</label>
                    <select id="fontSelect" onchange="changeFont()">
                        <option value="hiragino">ヒラギノ角ゴ（標準）</option>
                        <option value="yugothic">游ゴシック</option>
                        <option value="noto">Noto Sans JP</option>
                        <option value="arial">Arial（英語）</option>
                        <option value="roboto">Roboto（英語）</option>
                        <option value="opensans">Open Sans（英語）</option>
                        <option value="comic">コミック風</option>
                        <option value="serif">明朝体（セリフ）</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        選択したフォントはカード全体のテキストに適用されます
                    </small>
                </div>

                <!-- カラーカスタマイズ機能 -->
                <div class="form-group">
                    <label>🎨 カラーカスタマイズ</label>
                    <div class="color-customization">
                        <!-- カスタムカラー有効化 -->
                        <div class="custom-color-toggle" onclick="toggleCustomColorsUI()">
                            <input type="checkbox" id="enableCustomColors" onchange="toggleCustomColors()" onclick="event.stopPropagation()">
                            <span>カスタムカラーを使用</span>
                        </div>
                        
                        <!-- カラーピッカー（初期は非表示） -->
                        <div id="customColorsPanel" style="display: none;">
                            <div class="color-inputs">
                                <div class="color-input-group">
                                    <label for="primaryColor">背景開始色</label>
                                    <input type="color" id="primaryColor" value="#e6f8ff" onchange="updateCustomColors()">
                                </div>
                                <div class="color-input-group">
                                    <label for="secondaryColor">背景終了色</label>
                                    <input type="color" id="secondaryColor" value="#0077ff" onchange="updateCustomColors()">
                                </div>
                                <div class="color-input-group">
                                    <label for="accentColor">要素背景色</label>
                                    <input type="color" id="accentColor" value="#ffffff" onchange="updateCustomColors()">
                                </div>
                            </div>
                            
                            <!-- カスタムパレット保存 -->
                            <div class="palette-management">
                                <div style="display: flex; gap: 5px; margin-top: 10px;">
                                    <input type="text" id="paletteNameInput" placeholder="パレット名" style="flex: 1; padding: 4px;">
                                    <button type="button" onclick="saveCustomPalette()" style="padding: 4px 8px; font-size: 12px;">保存</button>
                                </div>
                                
                                <!-- 保存済みパレット一覧 -->
                                <div id="savedPalettes" style="margin-top: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        独自のブランドカラーでカードをカスタマイズできます（最大6個保存可能）
                    </small>
                </div>

                <div class="form-group">
                    <label for="resolutionSelect">出力サイズ</label>
                    <select id="resolutionSelect" disabled>
                        <option value="1.5" selected>中解像度 (888×600px) - 印刷最適化</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        印刷とWeb表示の両方に適した最適化サイズに固定されています
                    </small>
                </div>

                <div class="form-group">
                    <label for="patternTitle">パターン名</label>
                    <input type="text" id="patternTitle" placeholder="パターン名を入力" oninput="updateCard()">
                </div>

                <div class="form-group">
                    <label for="patternDescription">説明</label>
                    <textarea id="patternDescription" placeholder="パターンの説明を入力してください..." oninput="updateCard()"></textarea>
                </div>

                <div class="form-group">
                    <label for="patternContext">場面・状況</label>
                    <textarea id="patternContext" placeholder="パターンが適用される場面や状況を記述..." oninput="updateCard()"></textarea>
                </div>

                <div class="form-group">
                    <label for="patternSolution">工夫・トライアル</label>
                    <textarea id="patternSolution" placeholder="課題に対する工夫や試してみたいことを記述..." oninput="updateCard()"></textarea>
                </div>
            </div>

            <!-- メインエリア -->
            <div class="main-area">
                <!-- プレビューセクション -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h2>プレビュー</h2>
                        <span style="color: #666; font-size: 14px;">固定サイズ（888×600px）</span>
                    </div>
                    <div class="canvas-container">
                        <canvas id="cardCanvas"></canvas>
                    </div>
                </div>

                <!-- 一括生成セクション -->
                <div class="batch-section">
                    <!-- AI活用ガイドセクション -->
                    <div class="ai-guide-section">
                        <div class="ai-guide-header" onclick="toggleAIGuide()">
                            <div class="ai-guide-title">
                                <span>🤖</span>
                                <span>AIを活用したパターン・カードの作成 - CSV自動生成プロンプト  ※クリックして展開</span>
                            </div>
                            <span class="ai-guide-toggle" id="aiGuideToggle">▼</span>
                        </div>
                        <div class="ai-guide-content" id="aiGuideContent">
                            <div class="step-guide">
                                <h4>🚀 使い方の流れ</h4>
                                <ul class="step-list">
                                    <li><span class="step-number">1</span>下記からプロンプトテンプレートを選択</li>
                                    <li><span class="step-number">2</span>📋 コピーボタンでプロンプトをコピー</li>
                                    <li><span class="step-number">3</span>ChatGPT等の生成AIに貼り付けて実行</li>
                                    <li><span class="step-number">4</span>生成されたCSVを以下"カスタムカード作成用CSV一括読み込み"セクションで読み込み</li>
                                </ul>
                            </div>
                            
                            <div class="template-grid">
                                <!-- 書籍指定用テンプレート -->
                                <div class="template-card">
                                    <h4>📚 書籍指定用</h4>
                                    <textarea class="template-textarea" readonly>「[書籍名を入力]」の内容から、個人の学習・成長を促進する行動パターンを10-15個抽出し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description,context,solution

条件：
- pattern_numberは1から連番で番号を振る
- titleはパターン名を簡潔に（全角28文字以内）
- descriptionは説明文を全角50文字以内で簡潔に
- contextは「〜な状況で」という形で記述（全角50文字以内）
- solutionは具体的な行動として記述（全角50文字以内）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description,context,solution）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description,context,solution
1,疑問駆動型の学習,「なぜ？」を起点・足場にしながら深い理解への道筋を探る,新しい概念に出会ったがその本質が見えない状況で,まず「これは何のためにあるのか？ないとどうなるのか？」と問いかけ関連性を探ってみる</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'book')">📋 コピー</button>
                                </div>

                                <!-- 資料アップロード用テンプレート -->
                                <div class="template-card">
                                    <h4>📄 資料アップロード用</h4>
                                    <textarea class="template-textarea" readonly>アップロードした資料の内容から、個人の学習・成長を促進する行動パターンを10-15個抽出し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description,context,solution

条件：
- pattern_numberは1から連番で番号を振る
- titleはパターン名を簡潔に（全角28文字以内）
- descriptionは説明文を全角50文字以内で簡潔に
- contextは「〜な状況で」という形で記述（全角50文字以内）
- solutionは具体的な行動として記述（全角50文字以内）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description,context,solution）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description,context,solution
1,価値基準の見極め,本当に重要なことを判断する思考プロセスを呼び起こす,多くのタスクに追われ何から手をつけるべきか迷う状況で,「これは自分の目標にどう結びつけられるのか？」と自問して選択してみる</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'document')">📋 コピー</button>
                                </div>

                                <!-- ウェブリンク用テンプレート -->
                                <div class="template-card">
                                    <h4>🔗 ウェブリンク用</h4>
                                    <textarea class="template-textarea" readonly>次のリンク先の内容から、個人の学習・成長を促進する行動パターンを10-15個抽出し、以下のCSV形式で出力してください。→[URL を入力]

CSVヘッダー：
pattern_number,title,description,context,solution

条件：
- pattern_numberは1から連番で番号を振る
- titleはパターン名を簡潔に（全角28文字以内）
- descriptionは説明文を全角50文字以内で簡潔に
- contextは「〜な状況で」という形で記述（全角50文字以内）
- solutionは具体的な行動として記述（全角50文字以内）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description,context,solution）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description,context,solution
1,内発的動機の発見,「なぜこれをやりたいのか？」を問いかけ確認しながら進む,新しい習慣を始めてもモチベーションが続かない状況で,「これが達成されたら自分の何がどう変わりそうか？」と想像してみる</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'web')">📋 コピー</button>
                                </div>

                                <!-- 自由テーマ用テンプレート -->
                                <div class="template-card">
                                    <h4>💭 自由テーマ用</h4>
                                    <textarea class="template-textarea" readonly>「[テーマを入力（例：プログラミング学習、語学習得、キャリア開発など）」に関する個人の学習・成長を促進する行動パターンを10-15個作成し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description,context,solution

条件：
- pattern_numberは1から連番で番号を振る
- titleはパターン名を簡潔に（全角28文字以内）
- descriptionは説明文を全角50文字以内で簡潔に
- contextは「〜な状況で」という形で記述（全角50文字以内）
- solutionは具体的な行動として記述（全角50文字以内）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description,context,solution）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description,context,solution
1,コードとの対話,コードとの「会話」を通じて個々の要素を結びつけながら理解を深めていく,複雑なコードを前にして理解が進まない状況で,「この処理は何を解決しようとしているのか？」と問いかけてみる</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'theme')">📋 コピー</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CSV一括読み込みセクション -->
                    <div class="csv-section" style="margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #f1f3f4;">
                        <h2 style="margin-bottom: 20px; color: #444;">📄 カスタムカード作成用CSV一括読み込み</h2>
                        <div class="info-panel" style="margin-bottom: 15px;">
                            <h3>💡 データファイル読み込み機能</h3>
                            <p>データファイル（CSV形式）から複数のカスタムパターンカードを一括生成できます。<br>
                            <strong>✨ AIツール対応</strong>：Claude等で作成したファイルが.txt形式でも読み込めます<br>
                            <strong>テンプレート</strong>：現在選択中のデザインテンプレートが全カードに適用されます<br>
                            <strong>パターン番号</strong>：データの番号列に値があればカードに表示されます</p>
                            
                            <div style="margin-top: 10px; padding: 8px; background: #e8f4fd; border-radius: 4px; font-size: 13px;">
                                <strong>📖 対応ファイル形式</strong><br>
                                • <strong>.csv ファイル</strong>：Excel等で作成した標準的なCSVファイル<br>
                                • <strong>.txt ファイル</strong>：Claude等のAIツールで作成されたテキストファイル<br>
                                <small>※どちらもCSV形式（カンマ区切り）の内容である必要があります</small>
                            </div>
                        </div>
                        
                        <div class="csv-controls" style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                            <input type="file" id="csvFileInput" accept=".csv,.txt" style="display: none;" onchange="handleCSVUpload(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('csvFileInput').click()">
                                📁 データファイルを選択（CSV・TXT対応）
                            </button>
                            <button class="btn btn-secondary" onclick="downloadCSVTemplate()" title="サンプルCSVファイルをダウンロード">
                                📋 テンプレートDL
                            </button>
                            
                            <!-- ファイル名カスタマイズ機能 -->
                            <div style="display: none; align-items: center; gap: 10px; margin-left: 20px;" id="fileNameCustomization" class="file-name-controls">
                                <label for="cardGroupName" style="font-size: 14px; color: #444; white-space: nowrap;">カードグループ名:</label>
                                <input type="text" id="cardGroupName" placeholder="例：プロジェクトA" 
                                       style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 140px;"
                                       title="ファイル名の接頭辞となります（例：プロジェクトA_1.png）">
                                <small style="color: #666; font-size: 12px; white-space: nowrap;">→ {グループ名}_{番号}.png</small>
                            </div>
                            
                            <!-- ダウンロード方式選択 -->
                            <div id="downloadMethodSection" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 6px;">
                                <label style="font-size: 14px; color: #444; margin-bottom: 8px; display: block;">📦 ダウンロード方式:</label>
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="downloadMethod" value="individual" checked 
                                               style="margin-right: 6px;">
                                        <span style="font-size: 13px;">個別ダウンロード</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="downloadMethod" value="zip" 
                                               style="margin-right: 6px;">
                                        <span style="font-size: 13px;">ZIP一括ダウンロード</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="generateCSVBatch()" id="generateCSVBtn" style="display: none;">
                                🎨 CSVデータを一括生成
                            </button>
                            
                            <!-- CSVセクション専用プログレスバー -->
                            <div class="progress-bar" id="csvProgressBar" style="display: none;">
                                <div class="progress-fill" id="csvProgressFill"></div>
                            </div>
                        </div>
                        
                        <div id="csvPreview" style="display: none;">
                            <h4 style="margin-bottom: 10px; color: #667eea;">📊 読み込み予定のデータ</h4>
                            <div id="csvDataTable" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 6px; background: #fafbfc;">
                                <!-- CSVデータのプレビューテーブルが表示される -->
                            </div>
                            <div id="csvStats" style="margin-top: 10px; font-size: 13px; color: #666;">
                                <!-- 統計情報が表示される -->
                            </div>
                            
                            <!-- CSV行編集セクション（CSVプレビュー直下に配置） -->
                            <div id="csvEditSection" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 8px;">
                                <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">📝 CSV行編集</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <div id="csvEditInfo" style="font-size: 12px; color: #666; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                                    <!-- 左側：基本情報 -->
                                    <div>
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditNumber" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">パターン番号</label>
                                            <input type="text" id="csvEditNumber" style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;" oninput="updateCardFromCSVEdit()">
                                        </div>
                                        
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditTitle" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">タイトル</label>
                                            <input type="text" id="csvEditTitle" style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;" oninput="updateCardFromCSVEdit()">
                                        </div>
                                        
                                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                                            <button class="btn btn-primary" onclick="applyCSVEdit()" style="flex: 1; padding: 8px; font-size: 12px;">✅ 適用</button>
                                            <button class="btn btn-secondary" onclick="cancelCSVEdit()" style="flex: 1; padding: 8px; font-size: 12px;">❌ キャンセル</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 右側：詳細情報 -->
                                    <div>
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditDescription" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">説明</label>
                                            <textarea id="csvEditDescription" style="width: 100%; min-height: 50px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                        
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditContext" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">場面・状況</label>
                                            <textarea id="csvEditContext" style="width: 100%; min-height: 40px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                        
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditSolution" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">工夫・トライアル</label>
                                            <textarea id="csvEditSolution" style="width: 100%; min-height: 40px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h2 style="margin-bottom: 20px; color: #444;">パターンカード（プリセット分）一括生成</h2>
                    
                    <!-- プリセット版ダウンロード方式選択 -->
                    <div id="presetDownloadMethodSection" style="margin-bottom: 15px; padding: 10px; background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 6px;">
                        <label style="font-size: 14px; color: #444; margin-bottom: 8px; display: block;">📦 ダウンロード方式:</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="presetDownloadMethod" value="individual" checked 
                                       style="margin-right: 6px;">
                                <span style="font-size: 13px;">個別ダウンロード</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="presetDownloadMethod" value="zip" 
                                       style="margin-right: 6px;">
                                <span style="font-size: 13px;">ZIP一括ダウンロード</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="batch-controls">
                        <button class="btn btn-secondary" onclick="selectAllPatterns()">
                            ✅ 全選択
                        </button>
                        <button class="btn btn-secondary" onclick="clearSelection()">
                            ❌ 選択解除
                        </button>
                        <button class="btn btn-primary" onclick="generateBatch()" id="generateBatchBtn">
                            🎨 選択したカードを一括生成
                        </button>
                    </div>
                    
                    <!-- プリセットセクション専用プログレスバー -->
                    <div class="progress-bar" id="presetProgressBar" style="display: none;">
                        <div class="progress-fill" id="presetProgressFill"></div>
                    </div>
                    
                    <div class="pattern-grid" id="patternGrid">
                        <!-- パターン選択項目は JavaScript で生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas;
        let currentTemplate = 'academic';
        let selectedPatterns = new Set();
        let customBackgroundImage = null;
        let csvData = []; // CSV読み込みデータ
        let currentFont = 'hiragino'; // 選択中のフォント
        
        // 中解像度に固定（888×600px）
        const baseWidth = 888;
        const baseHeight = 600;
        
        // 文字幅計算・改行機能
        function isFullWidth(char) {
            // 全角文字判定（ひらがな、カタカナ、漢字、全角記号等）
            const code = char.charCodeAt(0);
            return (code >= 0x3000 && code <= 0x9FAF) || // CJK統合漢字、ひらがな、カタカナ
                   (code >= 0xFF01 && code <= 0xFF60) || // 全角ASCII
                   (code >= 0xFFE0 && code <= 0xFFE6);   // 全角記号
        }
        
        function insertLineBreaks(text, maxFullWidthChars = 36) {
            if (!text) return text;

            const maxHalfWidthChars = maxFullWidthChars * 2; // 36 * 2 = 72
            const chars = Array.from(text); // Unicode対応
            let result = '';
            let lineLength = 0;
            
            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];
                const charWidth = isFullWidth(char) ? 2 : 1;
                
                // 改行文字の場合はリセット
                if (char === '\n') {
                    result += char;
                    lineLength = 0;
                    continue;
                }
                
                // 行の長さが制限を超える場合は改行
                if (lineLength + charWidth > maxHalfWidthChars && lineLength > 0) {
                    result += '\n';
                    lineLength = 0;
                }
                
                result += char;
                lineLength += charWidth;
            }
            
            return result;
        }
        
        // フォント定義
        const fontDefinitions = {
            hiragino: {
                name: 'ヒラギノ角ゴ ProN',
                family: "'ヒラギノ角ゴ ProN', 'Hiragino Kaku Gothic ProN', '游ゴシック', YuGothic, sans-serif",
                webFont: null
            },
            yugothic: {
                name: '游ゴシック',
                family: "'游ゴシック', YuGothic, 'ヒラギノ角ゴ ProN', sans-serif",
                webFont: null
            },
            noto: {
                name: 'Noto Sans JP',
                family: "'Noto Sans JP', sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap'
            },
            arial: {
                name: 'Arial',
                family: "Arial, 'Helvetica Neue', Helvetica, sans-serif",
                webFont: null
            },
            roboto: {
                name: 'Roboto',
                family: "'Roboto', Arial, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap'
            },
            opensans: {
                name: 'Open Sans',
                family: "'Open Sans', Arial, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap'
            },
            comic: {
                name: 'コミック風',
                family: "'Comic Sans MS', 'Kosugi Maru', cursive, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap'
            },
            serif: {
                name: '明朝体',
                family: "'Times New Roman', 'ヒラギノ明朝 ProN', 'Hiragino Mincho ProN', '游明朝', YuMincho, serif",
                webFont: null
            }
        };
        
        // パターンデータ（井庭崇の40個のラーニング・パターン完全版）
        const patternData = {
            0: { title: "学習をデザインする", description: "自分なりの学習方法をデザインし、創造的な学習を実現する。", context: "学習を始めるとき、新しい分野を学習するとき。", solution: "学習目標を明確にし、自分に合った学習スタイルを設計する。" },
            1: { title: "機会をつくる", description: "学習の機会を積極的に創り出し、学びのきっかけを増やす。", context: "学習機会が少ないと感じるとき。", solution: "環境や人との関わりを通じて、新しい学習機会を作り出す。" },
            2: { title: "創造的なプロジェクト", description: "プロジェクトを通じた実践的で創造的な学習を行う。", context: "実践的なスキルを身につけたいとき。", solution: "具体的なアウトプットを目標にしたプロジェクトに取り組む。" },
            3: { title: "オープンプロセスな学び", description: "学習プロセスをオープンにし、他者と共有しながら学ぶ。", context: "一人で学習していて行き詰まりを感じるとき。", solution: "学習過程を可視化し、他者との対話を通じて学びを深める。" },
            4: { title: "まずはつかる", description: "完璧を求めず、まずは飛び込んで体験から学ぶ。", context: "新しいことを始める際に躊躇してしまうとき。", solution: "準備よりもまず行動し、体験を通じて学習を開始する。" },
            5: { title: "見まね学習", description: "優れた事例を模倣することから学習を始める。", context: "何から始めればよいかわからないとき。", solution: "熟練者の行動を観察し、まずは真似することから始める。" },
            6: { title: "効果的な質問", description: "適切な質問を通じて学習を深化させ、新しい洞察を得る。", context: "理解が表面的に留まっているとき、学びを深めたいとき。", solution: "核心を突く質問を投げかけ、考えを整理し理解を深める。" },
            7: { title: "アウトプット志向の学習", description: "何かを作り出すことを通じて知識とスキルを向上させる。", context: "勉強時、クラス選択時、新しいスキルを学びたいとき。", solution: "アウトプットを作ることを目標に学習し、プロセスでスキルを向上させる。" },
            8: { title: "毎日外国語", description: "外国語学習を日常的な習慣にして継続的にスキルを向上させる。", context: "外国語を習得したいとき、語学スキルを維持したいとき。", solution: "毎日少しずつでも外国語に触れる環境を作り、継続的に学習する。" },
            9: { title: "遊び心のある学習", description: "楽しみながら学ぶことで、学習の効果と持続性を高める。", context: "学習が退屈に感じるとき、モチベーションが低下したとき。", solution: "ゲーム要素や楽しい要素を取り入れて学習に遊び心を持たせる。" },
            10: { title: "身体化されたスキル", description: "身体的な体験を通じてスキルを習得し、深く身に付ける。", context: "実践的なスキルを身につけたいとき、理論だけでは不十分なとき。", solution: "実際に手を動かし、身体的な体験を通じてスキルを習得する。" },
            11: { title: "言葉のシャワー", description: "大量の情報に積極的に触れることで、知識の基盤を構築する。", context: "新しい分野の基礎知識を身につけたいとき。", solution: "関連する情報に積極的に浸り、知識のベースを広げる。" },
            12: { title: "有形の蓄積", description: "学習の成果を具体的な形で蓄積し、成長を可視化する。", context: "学習の進歩が見えにくいとき、モチベーションを保ちたいとき。", solution: "学習成果を物理的な形で残し、積み重ねを実感できるようにする。" },
            13: { title: "学習の竜巻", description: "興味と関連して知識を積極的につかみ、学習に勢いをつける。", context: "勉強、読書、研究を行う時、自分なりの方法でやりたい時。", solution: "興味に合った学習を選び、情報を積極的につかんで知識を混合する。" },
            14: { title: "三角スケーリング", description: "段階的にレベルを上げながら学習し、着実にスキルアップする。", context: "複雑なスキルを身につけたいとき、段階的成長を求めるとき。", solution: "基礎から応用へと三角形のように段階的に学習範囲を拡大する。" },
            15: { title: "興奮の連鎖！", description: "学習への興奮を連鎖させ、継続的な学習意欲を維持する。", context: "学習のモチベーションを高めたいとき、熱意を持続させたいとき。", solution: "一つの学びの興奮を次の学習につなげ、連鎖的に学習意欲を高める。" },
            16: { title: "行動の中での思考", description: "実際に行動しながら思考し、実践的な理解を深める。", context: "理論だけでは理解が進まないとき、実践的思考力を養いたいとき。", solution: "行動と思考を同時に行い、実践の中で理解を深める。" },
            17: { title: "プロトタイピング", description: "試作品や原型を作ることで学習し、改善を重ねる。", context: "新しいアイデアを形にしたいとき、実践的に学びたいとき。", solution: "まず簡単な原型を作り、試行錯誤を通じて理解と技術を向上させる。" },
            18: { title: "フィールドダイビング", description: "実際の現場に深く飛び込んで、生きた知識を獲得する。", context: "理論と実践のギャップを埋めたいとき、リアルな体験を求めるとき。", solution: "実際の現場や環境に身を置き、生の体験から学習する。" },
            19: { title: "マルチカメラ撮影", description: "複数の視点から物事を捉え、多角的な理解を得る。", context: "一つの視点だけでは理解が限定的なとき、包括的理解を求めるとき。", solution: "異なる角度や立場から同じ事象を観察し、多面的に理解する。" },
            20: { title: "鳥の目・虫の目", description: "大局的視点と詳細な視点を使い分けて、バランスの取れた理解を得る。", context: "全体像が見えないとき、または詳細が見落とされがちなとき。", solution: "マクロとミクロの視点を意識的に切り替えて学習する。" },
            21: { title: "隠れたつながり", description: "一見関係のない物事間の隠れた関連性を発見し、新たな洞察を得る。", context: "勉強、研究、読書、新しい視点が必要な時、クラス選択時。", solution: "学問分野を超えた共通の言葉や研究者を通じてつながりを見つける。" },
            22: { title: "フロンティア発見者", description: "未開拓の領域や新しい可能性を積極的に探求する。", context: "新しい分野を開拓したいとき、イノベーションを求めるとき。", solution: "既存の枠を超えて新しい領域を探求し、フロンティアを開拓する。" },
            23: { title: "創造的スイッチ", description: "創造性を発揮するためのスイッチを意識的に切り替える。", context: "アイデアが出ないとき、創造的思考が必要なとき。", solution: "環境や思考モードを意識的に変えて創造性を刺激する。" },
            24: { title: "果物農業", description: "長期的な視点で学習を育て、時間をかけて成果を収穫する。", context: "即座の成果が見えにくい長期的学習に取り組むとき。", solution: "植物を育てるように、時間をかけて学習を育て、成果を待つ。" },
            25: { title: "初稿は道半ば", description: "完璧を求めずに最初の版を作り、改善を重ねる。", context: "完璧主義で前に進めないとき、アウトプットを出したいとき。", solution: "まず不完全でも形にし、その後改善を重ねて質を高める。" },
            26: { title: "魅力的表現", description: "学習内容を魅力的に表現し、他者との共有を促進する。", context: "学習内容を他者に伝えたいとき、表現力を高めたいとき。", solution: "聞き手を意識した魅力的な表現方法を工夫し、効果的に伝える。" },
            27: { title: "次への加速", description: "一段階の学習完了を次の学習への推進力に変える。", context: "学習の区切りがついたとき、次のステップに進みたいとき。", solution: "達成感を原動力として、より高いレベルの学習に挑戦する。" },
            28: { title: "学習のコミュニティ", description: "同じ目標を持つ仲間とコミュニティを形成し、共に学習する。", context: "一人での学習に限界を感じるとき、仲間と学びたいとき。", solution: "学習コミュニティを形成し、メンバー間で支援し合いながら学習する。" },
            29: { title: "偶然の出会い", description: "予期しない出会いや発見から学習機会を創り出す。", context: "新しい刺激や発見を求めるとき、学習の幅を広げたいとき。", solution: "偶然の出会いに心を開き、そこから学習のきっかけを見つける。" },
            30: { title: "良きライバル", description: "互いに高め合える競争相手との関係を学習に活用する。", context: "学習のモチベーションを高めたいとき、切磋琢磨したいとき。", solution: "良い競争相手を見つけ、互いに刺激し合いながら成長する。" },
            31: { title: "話す思考者", description: "声に出して考えることで思考を整理し、理解を深める。", context: "考えがまとまらないとき、思考を整理したいとき。", solution: "考えを声に出して整理し、対話を通じて理解を深める。" },
            32: { title: "教えることによる学習", description: "他者に教えることで自分の理解を深め、知識を定着させる。", context: "知識を定着させたいとき、理解の深化を図りたいとき。", solution: "学んだことを他者に教える機会を作り、教える過程で学習する。" },
            33: { title: "確固たる決意", description: "明確な意志を持って学習に取り組み、困難を乗り越える。", context: "困難な学習に挑戦するとき、意志を強く持ちたいとき。", solution: "学習への強い決意を持ち、目標達成まで諦めずに取り組む。" },
            34: { title: "疑問を持つ心", description: "常に疑問を持ち続け、批判的思考で学習を深める。", context: "受動的な学習になっているとき、批判的思考力を養いたいとき。", solution: "与えられた情報に疑問を持ち、自分なりに考え抜く姿勢を保つ。" },
            35: { title: "正しい方法", description: "効果的で正確な学習方法を見つけ、質の高い学習を実現する。", context: "学習効率を上げたいとき、正確な知識を身につけたいとき。", solution: "検証済みの効果的な学習方法を採用し、質の高い学習を行う。" },
            36: { title: "勇敢な変化", description: "既存の方法に固執せず、勇気を持って新しい学習法に挑戦する。", context: "学習方法を変える必要があるとき、新しい挑戦をしたいとき。", solution: "現状に満足せず、勇気を持って新しい学習方法に挑戦する。" },
            37: { title: "探検家の情熱", description: "未知の領域への探求心を持ち続け、学習への情熱を維持する。", context: "学習への情熱を維持したいとき、探求心を失いかけているとき。", solution: "探検家のような情熱と好奇心を持ち続け、学習に取り組む。" },
            38: { title: "自己プロデューサー", description: "自分自身の学習をプロデュースし、主体的に学習環境を創造する。", context: "主体的な学習を実現したいとき、学習環境を改善したいとき。", solution: "自分の学習を客観視し、プロデューサーの視点で最適化する。" },
            39: { title: "極端になれ！", description: "時には極端なアプローチを取り、従来の枠を破って学習する。", context: "従来の方法では成果が出ないとき、ブレイクスルーが必要なとき。", solution: "常識にとらわれず、時には極端なアプローチで学習に取り組む。" }
        };
        
        // Canvas初期化
        function initCanvas() {
            try {
                const canvasElement = document.getElementById('cardCanvas');
                if (!canvasElement) {
                    console.error('Canvas要素が見つかりません');
                    return;
                }
                
                // Canvas初期化（888×600px固定）
                canvas = new fabric.Canvas('cardCanvas', {
                    width: baseWidth,
                    height: baseHeight,
                    backgroundColor: '#ffffff'
                });
                
                // 表示サイズを888×600pxに固定
                canvasElement.style.width = baseWidth + 'px';
                canvasElement.style.height = baseHeight + 'px';
                
                updateCard();
            } catch (error) {
                console.error('Canvas初期化エラー:', error);
                alert('Canvas初期化に失敗しました。ページをリロードしてください。');
            }
        }
        
        // 16進数カラーをRGBAに変換するヘルパー関数
        function hexToRgba(hex, alpha = 1) {
            // #を除去
            hex = hex.replace('#', '');
            
            // 3桁の場合は6桁に拡張
            if (hex.length === 3) {
                hex = hex.split('').map(char => char + char).join('');
            }
            
            // RGBに変換
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        // 解像度更新（固定のため無効化）
        function updateResolution() {
            // 中解像度固定のため処理なし
        }
        
        // テンプレート選択
        function selectTemplate(template) {
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-template="${template}"]`).classList.add('active');
            currentTemplate = template;
            
            // カスタム背景アップロード欄の表示/非表示
            const customGroup = document.getElementById('customBackgroundGroup');
            if (template === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
            
            // カスタムカラーが有効な場合は無効化
            if (document.getElementById('enableCustomColors').checked) {
                document.getElementById('enableCustomColors').checked = false;
                toggleCustomColors();
            }
            
            updateCard();
        }

        // カラーカスタマイズ機能
        let customColors = null;
        let savedPalettes = JSON.parse(localStorage.getItem('learning-pattern-palettes') || '[]');

        function toggleCustomColors() {
            const checkbox = document.getElementById('enableCustomColors');
            const panel = document.getElementById('customColorsPanel');
            const toggle = document.querySelector('.custom-color-toggle');
            
            if (checkbox.checked) {
                panel.style.display = 'block';
                toggle.classList.add('active');
                // 現在のテンプレートの色を初期値として設定
                const templateColors = {
                    academic: { primary: '#ffffff', secondary: '#d0d0d0', accent: '#ffffff' },
                    nature: { primary: '#259e56', secondary: '#f4f269', accent: '#ffffff' },
                    warm: { primary: '#fff95b', secondary: '#ff930f', accent: '#ffffff' },
                    elegant: { primary: '#d4af37', secondary: '#c0c0c0', accent: '#ffffff' },
                    pastel: { primary: '#e9e9b7', secondary: '#d3f3f1', accent: '#ffffff' },
                    spring: { primary: '#fce9d7', secondary: '#eed4e8', accent: '#ffffff' },
                    summer: { primary: '#f6f6f6', secondary: '#2c6cbc', accent: '#ffffff' },
                    autumn: { primary: '#fdd57e', secondary: '#924e8c', accent: '#ffffff' },
                    winter: { primary: '#f1f5f9', secondary: '#475569', accent: '#ffffff' },
                    custom: { primary: '#f5f5f5', secondary: '#e8e8e8', accent: '#ffffff' }
                };
                
                const colors = templateColors[currentTemplate] || templateColors.academic;
                document.getElementById('primaryColor').value = colors.primary;
                document.getElementById('secondaryColor').value = colors.secondary;
                document.getElementById('accentColor').value = colors.accent;
                updateCustomColors();
            } else {
                panel.style.display = 'none';
                toggle.classList.remove('active');
                customColors = null;
                updateCard();
            }
        }
        
        // UI用のトグル関数（ラベルクリック対応）
        function toggleCustomColorsUI() {
            const checkbox = document.getElementById('enableCustomColors');
            checkbox.checked = !checkbox.checked;
            toggleCustomColors();
        }

        function updateCustomColors() {
            customColors = {
                primary: document.getElementById('primaryColor').value,
                secondary: document.getElementById('secondaryColor').value,
                accent: document.getElementById('accentColor').value
            };
            updateCard();
        }

        function saveCustomPalette() {
            const nameInput = document.getElementById('paletteNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('パレット名を入力してください');
                return;
            }
            
            if (!customColors) {
                alert('カスタムカラーを設定してください');
                return;
            }
            
            if (savedPalettes.length >= 6) {
                alert('パレットは最大6個まで保存できます');
                return;
            }
            
            if (savedPalettes.find(p => p.name === name)) {
                alert('同じ名前のパレットが既に存在します');
                return;
            }
            
            savedPalettes.push({
                name: name,
                colors: { ...customColors }
            });
            
            localStorage.setItem('learning-pattern-palettes', JSON.stringify(savedPalettes));
            nameInput.value = '';
            renderSavedPalettes();
        }

        function loadCustomPalette(index) {
            const palette = savedPalettes[index];
            if (!palette) return;
            
            document.getElementById('enableCustomColors').checked = true;
            toggleCustomColors();
            
            document.getElementById('primaryColor').value = palette.colors.primary;
            document.getElementById('secondaryColor').value = palette.colors.secondary;
            document.getElementById('accentColor').value = palette.colors.accent;
            updateCustomColors();
        }

        function deleteCustomPalette(index) {
            if (confirm('このパレットを削除しますか？')) {
                savedPalettes.splice(index, 1);
                localStorage.setItem('learning-pattern-palettes', JSON.stringify(savedPalettes));
                renderSavedPalettes();
            }
        }

        function renderSavedPalettes() {
            const container = document.getElementById('savedPalettes');
            container.innerHTML = '';
            
            savedPalettes.forEach((palette, index) => {
                const div = document.createElement('div');
                div.className = 'saved-palette';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${palette.name}</span>
                        <div class="palette-colors">
                            <div class="palette-color-dot" style="background: ${palette.colors.primary}"></div>
                            <div class="palette-color-dot" style="background: ${palette.colors.secondary}"></div>
                            <div class="palette-color-dot" style="background: ${palette.colors.accent}"></div>
                        </div>
                    </div>
                    <div class="palette-actions">
                        <button class="palette-action-btn" onclick="loadCustomPalette(${index})">適用</button>
                        <button class="palette-action-btn" onclick="deleteCustomPalette(${index})">削除</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 初期化時に保存済みパレットを表示
        document.addEventListener('DOMContentLoaded', function() {
            renderSavedPalettes();
        });

        // 背景画像アップロード処理
        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    customBackgroundImage = img;
                    updateCard();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // パターンデータ読み込み
        function loadPatternData() {
            const select = document.getElementById('patternSelect');
            const patternId = select.value;
            
            if (patternId && patternData[patternId]) {
                const data = patternData[patternId];
                document.getElementById('patternTitle').value = data.title;
                document.getElementById('patternDescription').value = data.description;
                document.getElementById('patternContext').value = data.context;
                document.getElementById('patternSolution').value = data.solution;
                updateCard();
            }
        }
        
        // カード更新
        function updateCard() {
            if (!canvas) {
                console.warn('Canvas未初期化のため、カード更新をスキップします');
                return;
            }
            
            try {
                const title = document.getElementById('patternTitle').value || 'パターン名';
                const description = document.getElementById('patternDescription').value || '';
                const context = document.getElementById('patternContext').value || '';
                const solution = document.getElementById('patternSolution').value || '';
                const patternNumber = document.getElementById('patternSelect').value || '';
                
                canvas.clear();
                
                // テンプレート別の色設定（プリセット拡張）
                const templateColors = {
                    academic: { primary: '#ffffff', secondary: '#d0d0d0', accent: '#ffffff' },
                    nature: { primary: '#259e56', secondary: '#f4f269', accent: '#ffffff' },
                    warm: { primary: '#fff95b', secondary: '#ff930f', accent: '#ffffff' },
                    elegant: { primary: '#d4af37', secondary: '#c0c0c0', accent: '#ffffff' },
                    pastel: { primary: '#e9e9b7', secondary: '#d3f3f1', accent: '#ffffff' },
                    spring: { primary: '#fce9d7', secondary: '#eed4e8', accent: '#ffffff' },
                    summer: { primary: '#f6f6f6', secondary: '#2c6cbc', accent: '#ffffff' },
                    autumn: { primary: '#fdd57e', secondary: '#924e8c', accent: '#ffffff' },
                    winter: { primary: '#f1f5f9', secondary: '#475569', accent: '#ffffff' },
                    custom: { primary: '#f5f5f5', secondary: '#e8e8e8', accent: '#ffffff' }
                };
                
                // カスタムカラーが設定されている場合は優先使用
                const colors = customColors || templateColors[currentTemplate] || templateColors.academic;
                
                // 888×600px固定サイズ
                const width = baseWidth;
                const height = baseHeight;
            
            // 背景作成
            let background;
            if (currentTemplate === 'custom' && customBackgroundImage) {
                // カスタム背景画像を使用
                background = fabric.util.object.clone(customBackgroundImage);
                background.set({
                    left: 0,
                    top: 0,
                    scaleX: width / background.width,
                    scaleY: height / background.height,
                    selectable: false
                });
            } else {
                // グラデーション背景
                const gradient = new fabric.Gradient({
                    type: 'linear',
                    coords: { x1: 0, y1: 0, x2: width, y2: height },
                    colorStops: [
                        { offset: 0, color: colors.primary },
                        { offset: 1, color: colors.secondary }
                    ]
                });
                
                background = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: width,
                    height: height,
                    fill: gradient,
                    selectable: false
                });
            }
            canvas.add(background);
            
            // パターン番号（左上）- 888×600px用にサイズ調整（見出しと高さ統一、適度な間隔確保）
            if (patternNumber) {
                const numberCircle = new fabric.Circle({
                    left: 45,
                    top: 38,
                    radius: 30,
                    fill: colors.accent,
                    selectable: false
                });
                canvas.add(numberCircle);
                
                const numberText = new fabric.Text(patternNumber, {
                    left: 75,
                    top: 52,
                    fontSize: 32,
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'bold',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'top',
                    selectable: false
                });
                canvas.add(numberText);
            }
            
            // タイトル背景（白い角丸）- 888×600px用にサイズ調整（番号と適度な間隔を確保）
            const titleWidth = patternNumber ? 728 : 798;
            const titleLeft = patternNumber ? 115 : 45;
            
            // 曲線的な透明度変化を作るグラデーション（中央まではゆるやか、その後急激に透明に）
            const titleGradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: titleWidth, y2: 0 },
                colorStops: [
                    { offset: 0, color: hexToRgba(colors.accent, 0.9) },     // 左端：10%透明度
                    { offset: 0.4, color: hexToRgba(colors.accent, 0.9) },   // 40%地点：10%透明度
                    { offset: 0.6, color: hexToRgba(colors.accent, 0.8) },    // 60%地点：20%透明度
                    { offset: 0.8, color: hexToRgba(colors.accent, 0.4) },    // 80%地点：60%透明度
                    { offset: 1, color: hexToRgba(colors.accent, 0.0) }       // 右端：完全透明
                ]
            });
            
            const titleBg = new fabric.Rect({
                left: titleLeft,
                top: 38,
                width: titleWidth,
                height: 60,
                fill: titleGradient,
                rx: 12,
                ry: 12,
                shadow: {
                    color: 'rgba(0,0,0,0.1)',
                    blur: 15,
                    offsetX: 0,
                    offsetY: 3
                },
                selectable: false
            });
            canvas.add(titleBg);
            
            // タイトル - 888×600px用にフォントサイズ調整（カード番号と垂直位置統一、2px上に調整）
            const titleText = new fabric.Text(title, {
                left: patternNumber ? 125 : 60,
                top: 52,
                fontSize: 36,
                fill: '#333333',
                fontFamily: getCurrentFontFamily(),
                fontWeight: 'bold',
                selectable: false
            });
            canvas.add(titleText);
            
            // コンテンツエリア（白い背景）- 888×600px用にサイズ調整
            const contentWidth = 798;
            
            // 曲線的な透明度変化を作るグラデーション（中央まではゆるやか、その後急激に透明に）
            const contentGradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: contentWidth, y2: 0 },
                colorStops: [
                    { offset: 0, color: hexToRgba(colors.accent, 0.9) },     // 左端：10%透明度
                    { offset: 0.4, color: hexToRgba(colors.accent, 0.9) },   // 40%地点：10%透明度
                    { offset: 0.6, color: hexToRgba(colors.accent, 0.8) },    // 60%地点：20%透明度
                    { offset: 0.8, color: hexToRgba(colors.accent, 0.4) },    // 80%地点：60%透明度
                    { offset: 1, color: hexToRgba(colors.accent, 0.1) }       // 右端：90%透明度
                ]
            });
            
            const contentBg = new fabric.Rect({
                left: 45,
                top: 120,
                width: contentWidth,
                height: 435,
                fill: contentGradient,
                rx: 18,
                ry: 18,
                shadow: {
                    color: 'rgba(0,0,0,0.2)',
                    blur: 23,
                    offsetX: 0,
                    offsetY: 8
                },
                selectable: false
            });
            canvas.add(contentBg);
            
            let yPosition = 150;
            
            // 説明 - 888×600px用にサイズ調整
            if (description) {
                const formattedDescription = insertLineBreaks(description);
                const descText = new fabric.Textbox(formattedDescription, {
                    left: 75,
                    top: yPosition,
                    width: 738,
                    fontSize: 21,
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    selectable: false
                });
                canvas.add(descText);
                // テキストボックスの実際の高さを取得
                canvas.renderAll();
                const actualHeight = descText.calcTextHeight();
                yPosition += Math.max(90, actualHeight + 30);
            }
            
            // コンテクスト - 888×600px用にサイズ調整
            if (context) {
                const contextLabel = new fabric.Text('📍 場面・状況', {
                    left: 75,
                    top: yPosition,
                    fontSize: 18,
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'bold',
                    selectable: false
                });
                canvas.add(contextLabel);
                
                const contextText = new fabric.Textbox(insertLineBreaks(context), {
                    left: 75,
                    top: yPosition + 30,
                    width: 738,
                    fontSize: 18,
                    fill: '#555555',
                    fontFamily: getCurrentFontFamily(),
                    selectable: false
                });
                canvas.add(contextText);
                canvas.renderAll();
                const contextHeight = contextText.calcTextHeight();
                yPosition += Math.max(105, contextHeight + 60);
            }
            
            // 解決策 - 888×600px用にサイズ調整
            if (solution && yPosition < 480) {
                const solutionLabel = new fabric.Text('💡 工夫・トライアル', {
                    left: 75,
                    top: yPosition,
                    fontSize: 18,
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'bold',
                    selectable: false
                });
                canvas.add(solutionLabel);
                
                const solutionText = new fabric.Textbox(insertLineBreaks(solution), {
                    left: 75,
                    top: yPosition + 30,
                    width: 738,
                    fontSize: 18,
                    fill: '#555555',
                    fontFamily: getCurrentFontFamily(),
                    selectable: false
                });
                canvas.add(solutionText);
            }
            
            canvas.renderAll();
        } catch (error) {
            console.error('カード更新エラー:', error);
        }
    }
        
        // 現在のカードをエクスポート（888×600px固定）
        function exportCurrentCard() {
            if (!canvas) {
                alert('カードが生成されていません。');
                return;
            }
            
            try {
                // 888×600pxでそのままエクスポート
                const title = document.getElementById('patternTitle').value || 'pattern-card';
                const safeTitle = title.replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                const link = document.createElement('a');
                link.download = `${safeTitle}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('エクスポートエラー:', error);
                alert('カードのエクスポートに失敗しました。');
            }
        }
        
        // パターングリッド初期化
        function initPatternGrid() {
            const grid = document.getElementById('patternGrid');
            for (let i = 0; i <= 39; i++) {
                const item = document.createElement('div');
                item.className = 'pattern-item';
                
                // パターン番号とタイトルを表示
                const patternTitle = patternData[i] ? patternData[i].title : 'パターン';
                item.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 2px;">${i}</div>
                    <div style="font-size: 9px; line-height: 1.2; text-align: center;">${patternTitle}</div>
                `;
                
                item.onclick = () => togglePatternSelection(i, item);
                grid.appendChild(item);
            }
        }
        
        // パターン選択切り替え
        function togglePatternSelection(patternId, element) {
            if (selectedPatterns.has(patternId)) {
                selectedPatterns.delete(patternId);
                element.classList.remove('selected');
            } else {
                selectedPatterns.add(patternId);
                element.classList.add('selected');
            }
            updateBatchButton();
        }
        
        // 全選択
        function selectAllPatterns() {
            selectedPatterns.clear();
            for (let i = 0; i <= 39; i++) {
                selectedPatterns.add(i);
            }
            document.querySelectorAll('.pattern-item').forEach(item => item.classList.add('selected'));
            updateBatchButton();
        }
        
        // 選択解除
        function clearSelection() {
            selectedPatterns.clear();
            document.querySelectorAll('.pattern-item').forEach(item => item.classList.remove('selected'));
            updateBatchButton();
        }
        
        // 一括生成ボタン更新
        function updateBatchButton() {
            const btn = document.getElementById('generateBatchBtn');
            btn.textContent = `🎨 選択したカードを一括生成 (${selectedPatterns.size})`;
            btn.disabled = selectedPatterns.size === 0;
        }
        
        // 一括生成
        async function generateBatch() {
            if (selectedPatterns.size === 0) return;
            
            // ダウンロード方式の取得
            const downloadMethod = document.querySelector('input[name="presetDownloadMethod"]:checked').value;
            
            // ブラウザの自動ダウンロード制限警告
            if (selectedPatterns.size > 5 && downloadMethod === 'individual') {
                const userConfirm = confirm(`${selectedPatterns.size}個のファイルをダウンロードします。ブラウザがポップアップをブロックする可能性があります。続行しますか？`);
                if (!userConfirm) return;
            }
            
            let confirmMessage = `${selectedPatterns.size}枚のプリセットカードを生成します。\n`;
            
            if (downloadMethod === 'zip') {
                confirmMessage += `\nダウンロード方式：ZIP一括ダウンロード\nZIPファイル名：learning_patterns.zip`;
            } else {
                confirmMessage += `\nダウンロード方式：個別ダウンロード`;
            }
            
            confirmMessage += `\n\nよろしいですか？`;
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            if (downloadMethod === 'zip') {
                await generatePresetZipBatch();
            } else {
                await generatePresetIndividualBatch();
            }
        }
        
        // プリセット個別ダウンロード処理
        async function generatePresetIndividualBatch() {
            const progressBar = document.getElementById('presetProgressBar');
            const progressFill = document.getElementById('presetProgressFill');
            
            progressBar.style.display = 'block';
            
            let completed = 0;
            const total = selectedPatterns.size;
            
            try {
                for (const patternId of selectedPatterns) {
                    // パターンデータを適用
                    if (patternData[patternId]) {
                        const data = patternData[patternId];
                        document.getElementById('patternTitle').value = data.title;
                        document.getElementById('patternDescription').value = data.description;
                        document.getElementById('patternContext').value = data.context;
                        document.getElementById('patternSolution').value = data.solution;
                        document.getElementById('patternSelect').value = patternId;
                    }
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                    // ダウンロード（新しいファイル命名規則）
                    try {
                        const link = document.createElement('a');
                        const filename = `learning_patterns_${patternId}`;
                        link.download = `${filename}.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                    } catch (error) {
                        console.error(`パターン${patternId}のダウンロードに失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // ダウンロード間隔を調整（ブラウザ制限回避）
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                alert(`プリセットカード一括生成が完了しました！\n生成数: ${completed}枚`);
                
            } catch (error) {
                console.error('一括生成エラー:', error);
                alert('一括生成中にエラーが発生しました。ブラウザのコンソールを確認してください。');
            }
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
        }
        
        // プリセットZIP一括ダウンロード処理
        async function generatePresetZipBatch() {
            const progressBar = document.getElementById('presetProgressBar');
            const progressFill = document.getElementById('presetProgressFill');
            
            progressBar.style.display = 'block';
            
            let completed = 0;
            const total = selectedPatterns.size;
            
            // JSZipインスタンスを作成
            const zip = new JSZip();
            
            try {
                for (const patternId of selectedPatterns) {
                    // パターンデータを適用
                    if (patternData[patternId]) {
                        const data = patternData[patternId];
                        document.getElementById('patternTitle').value = data.title;
                        document.getElementById('patternDescription').value = data.description;
                        document.getElementById('patternContext').value = data.context;
                        document.getElementById('patternSolution').value = data.solution;
                        document.getElementById('patternSelect').value = patternId;
                    }
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                    // 画像データをZIPに追加
                    try {
                        const dataURL = canvas.toDataURL('image/png');
                        const base64Data = dataURL.split(',')[1]; // data:image/png;base64, を除去
                        
                        // ファイル名：learning_patterns_{番号}.png
                        const filename = `learning_patterns_${patternId}.png`;
                        
                        zip.file(filename, base64Data, {base64: true});
                        
                    } catch (error) {
                        console.error(`パターン${patternId}のZIP追加に失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // 処理間隔を調整（ZIPの場合は短く）
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ZIP生成とダウンロード
                progressFill.innerHTML = '<span style="color: white; font-size: 12px;">ZIP生成中...</span>';
                
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6
                    }
                });
                
                // ZIPファイルをダウンロード
                const link = document.createElement('a');
                link.download = 'learning_patterns.zip';
                link.href = URL.createObjectURL(content);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // オブジェクトURLを解放
                URL.revokeObjectURL(link.href);
                
                alert(`プリセットカードZIP一括生成が完了しました！\n生成数: ${completed}枚\nZIPファイル: learning_patterns.zip`);
                
            } catch (error) {
                console.error('ZIP一括生成エラー:', error);
                alert('ZIP一括生成中にエラーが発生しました。');
            }
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                progressFill.innerHTML = '';
            }, 1000);
        }
        
        // フォント関連機能
        
        // WebFontの動的読み込み
        function loadWebFont(fontKey) {
            const font = fontDefinitions[fontKey];
            if (!font.webFont) return Promise.resolve(); // WebFontが不要な場合
            
            return new Promise((resolve, reject) => {
                // 既に読み込み済みかチェック
                const existingLink = document.querySelector(`link[href="${font.webFont}"]`);
                if (existingLink) {
                    resolve();
                    return;
                }
                
                // WebFont読み込み
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = font.webFont;
                link.onload = () => {
                    console.log(`WebFont loaded: ${font.name}`);
                    // フォント読み込み完了まで少し待つ
                    setTimeout(resolve, 200);
                };
                link.onerror = () => {
                    console.warn(`WebFont load failed: ${font.name}`);
                    resolve(); // エラーでも続行
                };
                
                document.head.appendChild(link);
            });
        }
        
        // フォント変更
        async function changeFont() {
            const fontSelect = document.getElementById('fontSelect');
            const selectedFont = fontSelect.value;
            
            try {
                // WebFont読み込み
                await loadWebFont(selectedFont);
                
                // 現在のフォントを更新
                currentFont = selectedFont;
                
                // カードを再描画
                updateCard();
                
                console.log(`フォント変更完了: ${fontDefinitions[selectedFont].name}`);
                
            } catch (error) {
                console.error('フォント変更エラー:', error);
                alert('フォントの変更に失敗しました。');
            }
        }
        
        // フォントファミリーを取得
        function getCurrentFontFamily() {
            return fontDefinitions[currentFont]?.family || fontDefinitions.hiragino.family;
        }
        function resetAll() {
            document.getElementById('patternSelect').value = '';
            document.getElementById('patternTitle').value = '';
            document.getElementById('patternDescription').value = '';
            document.getElementById('patternContext').value = '';
            document.getElementById('patternSolution').value = '';
            document.getElementById('fontSelect').value = 'hiragino'; // フォントもリセット
            currentFont = 'hiragino';
            clearSelection();
            clearCSVData(); // CSVデータもクリア（編集セクションも非表示になる）
            updateCard();
        }
        
        // CSV関連機能
        
        // CSVテンプレートダウンロード
        function downloadCSVTemplate() {
            const csvContent = 'pattern_number,title,description,context,solution\n' +
                              '1,サンプルパターン1,学習に関する説明文,適用される場面・状況,工夫やトライアル内容\n' +
                              '2,サンプルパターン2,学習に関する説明文2,適用される場面・状況2,工夫やトライアル内容2\n' +
                              ',独自パターン,説明文（パターン番号は任意）,場面・状況,工夫・トライアル';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'pattern_card_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // CSVファイルアップロード処理
        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ファイル形式チェック（.csv と .txt 両方対応）
            if (!file.name.match(/\.(csv|txt)$/i)) {
                alert('CSVまたはTXTファイルを選択してください。\n\n対応形式：\n• .csv ファイル（Excel等で作成）\n• .txt ファイル（Claude等のAIツールで作成）');
                return;
            }
            
            try {
                const text = await readFileAsText(file);
                
                // CSV形式の基本検証（カンマ区切りかチェック）
                if (!text.includes(',')) {
                    alert('ファイルがCSV形式（カンマ区切り）ではありません。\n\nAIツールで作成した場合は、CSV形式で出力されているか確認してください。\n\n正しい形式例：\ntitle,description,context,solution,pattern_number');
                    return;
                }
                
                const data = parseCSV(text);
                const validatedData = validateCSVData(data);
                
                if (validatedData.length === 0) {
                    alert('有効なデータが見つかりませんでした。\n\nファイルがCSV形式で、必要な列（title, description, context, solution）が含まれているか確認してください。');
                    return;
                }
                
                csvData = validatedData;
                displayCSVPreview(validatedData);
                document.getElementById('generateCSVBtn').style.display = 'inline-flex';
                document.getElementById('fileNameCustomization').style.display = 'flex';
                
            } catch (error) {
                alert('データファイルの読み込みに失敗しました。\n\nエラー詳細: ' + error.message + '\n\nファイルがCSV形式（カンマ区切り）で保存されているか確認してください。');
                console.error('ファイル読み込みエラー:', error);
            }
        }
        
        // ファイルをテキストとして読み込み
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('ファイル読み込みエラー'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // CSV解析
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSVファイルにはヘッダー行とデータ行が必要です。');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/["']/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index].trim().replace(/["']/g, '');
                    });
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // CSV行の解析（カンマとクォート処理）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"' || char === "'") {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // CSVデータバリデーション
        function validateCSVData(data) {
            const requiredFields = ['title', 'description', 'context', 'solution'];
            const validated = [];
            
            for (const row of data) {
                // 必須フィールドチェック
                let isValid = true;
                for (const field of requiredFields) {
                    if (!row[field] || row[field].trim() === '') {
                        console.warn(`行スキップ: ${field}が空です`, row);
                        isValid = false;
                        break;
                    }
                }
                
                if (!isValid) continue;
                
                // パターン番号の正規化
                if (!row.pattern_number || row.pattern_number.trim() === '') {
                    row.pattern_number = null;
                } else {
                    // パターン番号を文字列として保持
                    row.pattern_number = row.pattern_number.trim();
                }
                
                validated.push(row);
            }
            
            return validated;
        }
        
        // CSVプレビュー表示
        function displayCSVPreview(data) {
            const preview = document.getElementById('csvPreview');
            const table = document.getElementById('csvDataTable');
            const stats = document.getElementById('csvStats');
            
            // テーブル生成
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">番号</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">タイトル</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">説明</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">場面・状況</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">工夫・トライアル</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">操作</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach((row, index) => {
                html += `<tr id="csvRow${index}" style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9ff'};">`;
                html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${row.pattern_number || '-'}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.title}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.description.substring(0, 30)}${row.description.length > 30 ? '...' : ''}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.context.substring(0, 25)}${row.context.length > 25 ? '...' : ''}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.solution.substring(0, 25)}${row.solution.length > 25 ? '...' : ''}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">`;
                html += `<button onclick="editCSVRow(${index})" class="csv-edit-button">✏️編集</button>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            // 統計情報
            const withNumbers = data.filter(row => row.pattern_number).length;
            const withoutNumbers = data.length - withNumbers;
            
            stats.innerHTML = `📊 読み込み件数: ${data.length}件 | 番号付き: ${withNumbers}件, 番号なし: ${withoutNumbers}件 | 使用テンプレート: ${currentTemplate}`;
            
            preview.style.display = 'block';
            document.getElementById('downloadMethodSection').style.display = 'block';
        }
        
        // CSVデータクリア
        function clearCSVData() {
            csvData = [];
            document.getElementById('csvPreview').style.display = 'none';
            document.getElementById('downloadMethodSection').style.display = 'none';
            document.getElementById('generateCSVBtn').style.display = 'none';
            document.getElementById('fileNameCustomization').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('cardGroupName').value = '';
            
            // CSV編集セクションも非表示・ハイライト解除
            document.getElementById('csvEditSection').style.display = 'none';
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            editingCSVIndex = -1;
            originalCSVData = null;
        }
        
        // CSV一括生成
        async function generateCSVBatch() {
            if (csvData.length === 0) {
                alert('CSV データが読み込まれていません。');
                return;
            }
            
            // カードグループ名の取得と検証
            const cardGroupName = document.getElementById('cardGroupName').value.trim();
            if (!cardGroupName) {
                alert('カードグループ名を入力してください。\n\n例：プロジェクトA\n→ファイル名：プロジェクトA_1.png');
                document.getElementById('cardGroupName').focus();
                return;
            }
            
            // ダウンロード方式の取得
            const downloadMethod = document.querySelector('input[name="downloadMethod"]:checked').value;
            
            // ファイル名に使用できない文字を安全な文字に変換
            const safeGroupName = cardGroupName.replace(/[<>:"/\\|?*]/g, '-').replace(/\s+/g, '_');
            
            let confirmMessage = `${csvData.length}枚のカードを生成します。\n現在選択中のテンプレート「${currentTemplate}」を全カードに適用します。\nファイル名形式：${safeGroupName}_1.png, ${safeGroupName}_2.png...\n`;
            
            if (downloadMethod === 'zip') {
                confirmMessage += `\nダウンロード方式：ZIP一括ダウンロード\nZIPファイル名：${safeGroupName}_pattern_cards.zip`;
            } else {
                confirmMessage += `\nダウンロード方式：個別ダウンロード`;
            }
            
            confirmMessage += `\n\nよろしいですか？\n\n※ブラウザによってはダウンロードが制限される場合があります。`;
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            if (downloadMethod === 'zip') {
                await generateZipBatch(safeGroupName);
            } else {
                await generateIndividualBatch(safeGroupName);
            }
        }
        
        // 個別ダウンロード処理
        async function generateIndividualBatch(safeGroupName) {
            const progressBar = document.getElementById('csvProgressBar');
            const progressFill = document.getElementById('csvProgressFill');
            
            progressBar.style.display = 'block';
            
            // UI状態保存（一括生成中のパターン選択表示固定のため）
            const originalPatternValue = document.getElementById('patternSelect').value;
            
            let completed = 0;
            const total = csvData.length;
            
            try {
                for (const [index, row] of csvData.entries()) {
                    // データを入力フィールドに設定
                    document.getElementById('patternTitle').value = row.title;
                    document.getElementById('patternDescription').value = row.description;
                    document.getElementById('patternContext').value = row.context;
                    document.getElementById('patternSolution').value = row.solution;
                    
                    // パターン番号を設定（UIには反映させない）
                    // 注意: パターン選択UIは変更せず、内部的にのみ処理
                    if (row.pattern_number) {
                        // 内部的にパターン番号を保持（UIは変更しない）
                        // updateCard()で必要な場合は別途対応
                    }
                    
                    // 現在選択されているテンプレートを維持（変更しない）
                    // selectTemplate(currentTemplate); // 不要：既に選択済み
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // ダウンロード（新しいファイル命名規則）
                    try {
                        const link = document.createElement('a');
                        // カード番号の決定（CSV番号がある場合はそれを使用、なければ連番）
                        const cardNumber = row.pattern_number || (index + 1);
                        // 新しいファイル命名規則：{グループ名}_{カード番号}.png
                        const filename = `${safeGroupName}_${cardNumber}`;
                        link.download = `${filename}.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                    } catch (error) {
                        console.error(`CSV行${index + 1}のダウンロードに失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // ダウンロード間隔を調整
                    await new Promise(resolve => setTimeout(resolve, 400));
                }
                
                alert(`CSV一括生成が完了しました！\n生成数: ${completed}枚\nテンプレート: ${currentTemplate}`);
                
            } catch (error) {
                console.error('CSV一括生成エラー:', error);
                alert('CSV一括生成中にエラーが発生しました。');
            }
            
            // UI状態復元（パターン選択を元の状態に戻す）
            document.getElementById('patternSelect').value = originalPatternValue;
            // 元の状態でカード表示を更新
            updateCard();
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
        }
        
        // ZIP一括ダウンロード処理
        async function generateZipBatch(safeGroupName) {
            const progressBar = document.getElementById('csvProgressBar');
            const progressFill = document.getElementById('csvProgressFill');
            
            progressBar.style.display = 'block';
            
            // UI状態保存（一括生成中のパターン選択表示固定のため）
            const originalPatternValue = document.getElementById('patternSelect').value;
            
            let completed = 0;
            const total = csvData.length;
            
            // JSZipインスタンスを作成
            const zip = new JSZip();
            
            try {
                for (const [index, row] of csvData.entries()) {
                    // データを入力フィールドに設定
                    document.getElementById('patternTitle').value = row.title;
                    document.getElementById('patternDescription').value = row.description;
                    document.getElementById('patternContext').value = row.context;
                    document.getElementById('patternSolution').value = row.solution;
                    
                    // パターン番号を設定（UIには反映させない）
                    // 注意: パターン選択UIは変更せず、内部的にのみ処理
                    if (row.pattern_number) {
                        // 内部的にパターン番号を保持（UIは変更しない）
                        // updateCard()で必要な場合は別途対応
                    }
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // 画像データをZIPに追加
                    try {
                        const dataURL = canvas.toDataURL('image/png');
                        const base64Data = dataURL.split(',')[1]; // data:image/png;base64, を除去
                        
                        // カード番号の決定（CSV番号がある場合はそれを使用、なければ連番）
                        const cardNumber = row.pattern_number || (index + 1);
                        // ファイル名：{グループ名}_{カード番号}.png
                        const filename = `${safeGroupName}_${cardNumber}.png`;
                        
                        zip.file(filename, base64Data, {base64: true});
                        
                    } catch (error) {
                        console.error(`CSV行${index + 1}のZIP追加に失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // 処理間隔を調整（ZIPの場合は短く）
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ZIP生成とダウンロード
                progressFill.innerHTML = '<span style="color: white; font-size: 12px;">ZIP生成中...</span>';
                
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6
                    }
                });
                
                // ZIPファイルをダウンロード
                const link = document.createElement('a');
                link.download = `${safeGroupName}_pattern_cards.zip`;
                link.href = URL.createObjectURL(content);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // オブジェクトURLを解放
                URL.revokeObjectURL(link.href);
                
                alert(`ZIP一括生成が完了しました！\n生成数: ${completed}枚\nテンプレート: ${currentTemplate}\nZIPファイル: ${safeGroupName}_pattern_cards.zip`);
                
            } catch (error) {
                console.error('ZIP一括生成エラー:', error);
                alert('ZIP一括生成中にエラーが発生しました。');
            }
            
            // UI状態復元（パターン選択を元の状態に戻す）
            document.getElementById('patternSelect').value = originalPatternValue;
            // 元の状態でカード表示を更新
            updateCard();
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                progressFill.innerHTML = '';
            }, 1000);
        }
        
        // CSV行編集機能
        let editingCSVIndex = -1;
        let originalCSVData = null;
        
        function editCSVRow(index) {
            if (index < 0 || index >= csvData.length) return;
            
            editingCSVIndex = index;
            const row = csvData[index];
            
            // 以前の編集行のハイライトを削除
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            
            // 現在の編集行をハイライト
            const currentRow = document.getElementById(`csvRow${index}`);
            if (currentRow) {
                currentRow.classList.add('csv-row-editing');
            }
            
            // 編集セクションを表示
            document.getElementById('csvEditSection').style.display = 'block';
            
            // 編集情報を表示
            document.getElementById('csvEditInfo').textContent = `行 ${index + 1} / ${csvData.length} を編集中 - リアルタイムでカードプレビューが更新されます`;
            
            // フィールドに値を設定
            document.getElementById('csvEditNumber').value = row.pattern_number || '';
            document.getElementById('csvEditTitle').value = row.title || '';
            document.getElementById('csvEditDescription').value = row.description || '';
            document.getElementById('csvEditContext').value = row.context || '';
            document.getElementById('csvEditSolution').value = row.solution || '';
            
            // 元のメインフォームの値を保存
            originalCSVData = {
                patternSelect: document.getElementById('patternSelect').value,
                patternTitle: document.getElementById('patternTitle').value,
                patternDescription: document.getElementById('patternDescription').value,
                patternContext: document.getElementById('patternContext').value,
                patternSolution: document.getElementById('patternSolution').value
            };
            
            // 編集中のデータでカードを更新
            updateCardFromCSVEdit();
            
            // 編集セクションにスムーズスクロール
            document.getElementById('csvEditSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }
        
        function updateCardFromCSVEdit() {
            if (editingCSVIndex === -1) return;
            
            // 編集中の値をメインフォームに反映
            document.getElementById('patternSelect').value = document.getElementById('csvEditNumber').value;
            document.getElementById('patternTitle').value = document.getElementById('csvEditTitle').value;
            document.getElementById('patternDescription').value = document.getElementById('csvEditDescription').value;
            document.getElementById('patternContext').value = document.getElementById('csvEditContext').value;
            document.getElementById('patternSolution').value = document.getElementById('csvEditSolution').value;
            
            // カードを更新
            updateCard();
        }
        
        function applyCSVEdit() {
            if (editingCSVIndex === -1) return;
            
            // CSVデータを更新
            csvData[editingCSVIndex] = {
                pattern_number: document.getElementById('csvEditNumber').value || null,
                title: document.getElementById('csvEditTitle').value,
                description: document.getElementById('csvEditDescription').value,
                context: document.getElementById('csvEditContext').value,
                solution: document.getElementById('csvEditSolution').value
            };
            
            // プレビューテーブルを更新
            displayCSVPreview(csvData);
            
            // 編集完了
            cancelCSVEdit();
            
            alert('編集内容をCSVデータに適用しました。');
        }
        
        function cancelCSVEdit() {
            // 編集行のハイライトを削除
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            
            // 編集セクションを非表示
            document.getElementById('csvEditSection').style.display = 'none';
            editingCSVIndex = -1;
            
            // 元のフォーム値を復元
            if (originalCSVData) {
                document.getElementById('patternSelect').value = originalCSVData.patternSelect;
                document.getElementById('patternTitle').value = originalCSVData.patternTitle;
                document.getElementById('patternDescription').value = originalCSVData.patternDescription;
                document.getElementById('patternContext').value = originalCSVData.patternContext;
                document.getElementById('patternSolution').value = originalCSVData.patternSolution;
                
                // カードを元に戻す
                updateCard();
                
                originalCSVData = null;
            }
        }
        
        // 初期化
        function initialize() {
            // Fabric.jsが読み込まれているかチェック
            if (typeof fabric === 'undefined') {
                setTimeout(initialize, 100);
                return;
            }
            initCanvas();
            initPatternGrid();
            updateBatchButton();
            
            // CSV機能の初期化
            clearCSVData();
            
            // フォント初期化
            currentFont = 'hiragino';
            document.getElementById('fontSelect').value = 'hiragino';
        }
        
        window.addEventListener('load', initialize);

        // AI活用ガイド関連の関数
        function toggleAIGuide() {
            const content = document.getElementById('aiGuideContent');
            const toggle = document.getElementById('aiGuideToggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        function copyTemplate(button, type) {
            const textarea = button.previousElementSibling;
            const text = textarea.value;
            
            // クリップボードにコピー
            navigator.clipboard.writeText(text).then(() => {
                // ボタンの表示を変更
                const originalText = button.textContent;
                button.textContent = '✓ コピー完了!';
                button.classList.add('copied');
                
                // 2秒後に元に戻す
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                // フォールバック: テキストを選択
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                const originalText = button.textContent;
                button.textContent = '✓ コピー完了!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }
    </script>
</body>
</html>
